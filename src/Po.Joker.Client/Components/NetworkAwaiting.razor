@namespace Po.Joker.Client.Components
@implements IDisposable

<div class="network-awaiting @(IsVisible ? "visible" : "")">
    <div class="network-content">
        <p class="network-message">@Message</p>
        <p class="status-text">@StatusText</p>
        @if (ShowRetryButton)
        {
            <button class="retry-button" @onclick="OnRetryClicked" disabled="@IsRetrying">
                @(IsRetrying ? "Retrying..." : "Retry")
            </button>
        }
        @if (RetryCount > 0)
        {
            <p class="retry-count">Attempts: @RetryCount</p>
        }
    </div>
</div>

@code {
    private int _animationFrame;
    private System.Timers.Timer? _dotTimer;

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public string Message { get; set; } = "The royal messenger has lost their way. Please wait while we dispatch another courier.";

    [Parameter]
    public string StatusText { get; set; } = "Searching for a path to the server...";

    [Parameter]
    public bool ShowRetryButton { get; set; } = true;

    [Parameter]
    public bool IsRetrying { get; set; }

    [Parameter]
    public int RetryCount { get; set; }

    [Parameter]
    public EventCallback OnRetry { get; set; }

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            StartDotAnimation();
        }
        else
        {
            StopDotAnimation();
        }
    }

    private void StartDotAnimation()
    {
        if (_dotTimer != null) return;
        
        _animationFrame = 0;
        _dotTimer = new System.Timers.Timer(400);
        _dotTimer.Elapsed += async (sender, args) =>
        {
            _animationFrame = (_animationFrame % 3) + 1;
            await InvokeAsync(StateHasChanged);
        };
        _dotTimer.Start();
    }

    private void StopDotAnimation()
    {
        _dotTimer?.Stop();
        _dotTimer?.Dispose();
        _dotTimer = null;
        _animationFrame = 0;
    }

    private async Task OnRetryClicked()
    {
        await OnRetry.InvokeAsync();
    }

    public void Dispose()
    {
        StopDotAnimation();
    }
}
