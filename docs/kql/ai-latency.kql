// Po.Joker AI Latency Monitoring - Application Insights KQL Query
// This query monitors Azure OpenAI (AI Jester) response times and performance

// AI Service Latency Over Time (Last 24 Hours)
dependencies
| where timestamp > ago(24h)
| where target contains "openai" or name contains "OpenAI" or name contains "AiJester"
| summarize 
    AvgDuration = avg(duration),
    P50 = percentile(duration, 50),
    P90 = percentile(duration, 90),
    P99 = percentile(duration, 99),
    MaxDuration = max(duration),
    Calls = count()
    by bin(timestamp, 1h)
| order by timestamp desc
| project timestamp, AvgDuration = round(AvgDuration, 0), P50 = round(P50, 0), P90 = round(P90, 0), P99 = round(P99, 0), MaxDuration = round(MaxDuration, 0), Calls

// AI Service Success Rate
dependencies
| where timestamp > ago(24h)
| where target contains "openai" or name contains "OpenAI" or name contains "AiJester"
| summarize 
    TotalCalls = count(),
    SuccessfulCalls = countif(success == true),
    FailedCalls = countif(success == false)
    by bin(timestamp, 1h)
| extend SuccessRate = round(100.0 * SuccessfulCalls / TotalCalls, 2)
| order by timestamp desc
| project timestamp, TotalCalls, SuccessfulCalls, FailedCalls, SuccessRate

// AI Latency Percentiles (Last 7 Days)
dependencies
| where timestamp > ago(7d)
| where target contains "openai" or name contains "OpenAI" or name contains "AiJester"
| summarize 
    P50 = percentile(duration, 50),
    P75 = percentile(duration, 75),
    P90 = percentile(duration, 90),
    P95 = percentile(duration, 95),
    P99 = percentile(duration, 99)
| project 
    P50_ms = round(P50, 0),
    P75_ms = round(P75, 0),
    P90_ms = round(P90, 0),
    P95_ms = round(P95, 0),
    P99_ms = round(P99, 0)

// Slow AI Requests (Over 10 seconds)
dependencies
| where timestamp > ago(24h)
| where target contains "openai" or name contains "OpenAI" or name contains "AiJester"
| where duration > 10000
| project timestamp, name, target, duration_ms = round(duration, 0), success, resultCode
| order by duration_ms desc
| take 50

// AI Request Distribution by Response Time Buckets
dependencies
| where timestamp > ago(7d)
| where target contains "openai" or name contains "OpenAI" or name contains "AiJester"
| extend LatencyBucket = case(
    duration < 1000, "< 1s",
    duration < 3000, "1-3s",
    duration < 5000, "3-5s",
    duration < 10000, "5-10s",
    duration < 15000, "10-15s",
    "> 15s"
)
| summarize Count = count() by LatencyBucket
| order by LatencyBucket asc

// Joke Analysis Endpoint Performance (Full Request Cycle)
requests
| where timestamp > ago(24h)
| where name contains "analyze" or url contains "/api/jokes/analyze"
| summarize 
    AvgDuration = avg(duration),
    P50 = percentile(duration, 50),
    P90 = percentile(duration, 90),
    P99 = percentile(duration, 99),
    TotalRequests = count(),
    FailedRequests = countif(success == false)
    by bin(timestamp, 1h)
| extend SuccessRate = round(100.0 * (TotalRequests - FailedRequests) / TotalRequests, 2)
| order by timestamp desc
| project timestamp, AvgDuration = round(AvgDuration, 0), P50 = round(P50, 0), P90 = round(P90, 0), SuccessRate, TotalRequests

// AI Timeouts (Circuit Breaker Trigger Detection)
dependencies
| where timestamp > ago(24h)
| where target contains "openai" or name contains "OpenAI"
| where duration >= 15000 or resultCode == "Timeout" or success == false
| summarize TimeoutCount = count() by bin(timestamp, 1h)
| where TimeoutCount > 5
| project timestamp, TimeoutCount, Alert = "Potential circuit breaker activation"

// Token Usage Tracking (Custom Metric)
customMetrics
| where timestamp > ago(24h)
| where name == "ai.tokens.total" or name == "ai.tokens.prompt" or name == "ai.tokens.completion"
| summarize TotalTokens = sum(value) by bin(timestamp, 1h), name
| order by timestamp desc

// End-to-End Joke Processing Time (Including AI)
requests
| where timestamp > ago(24h)
| where name contains "analyze"
| join kind=inner (
    dependencies
    | where target contains "openai"
    | project request_id = operation_Id, AIDuration = duration
) on $left.operation_Id == $right.request_id
| summarize 
    AvgTotalDuration = avg(duration),
    AvgAIDuration = avg(AIDuration),
    AvgOverhead = avg(duration - AIDuration)
    by bin(timestamp, 1h)
| project timestamp, 
    TotalDuration_ms = round(AvgTotalDuration, 0),
    AIDuration_ms = round(AvgAIDuration, 0),
    Overhead_ms = round(AvgOverhead, 0),
    AIRatio = round(100.0 * AvgAIDuration / AvgTotalDuration, 1)
